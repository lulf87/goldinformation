# 黄金交易 Agent 项目实施计划

## 项目概述
构建一个本地运行的黄金交易决策辅助系统，提供可解释的中线交易信号。

### 核心目标
- 市场状态识别（趋势/震荡/不清晰）
- 交易信号生成（强买/买/观望/卖/强卖）
- 教学型解释输出
- Web 界面展示与交互

### 验收标准
- 输出包含：市场状态、信号等级、关键位、风险提示、仓位建议
- 每条建议都有解释
- 图表展示趋势与关键位
- 支持手动刷新与每日 14:00 自动更新

---

## 实施阶段

### 阶段 1: 项目架构设计与技术选型
**状态**: `complete`
**目标**: 确定技术栈和项目结构

**任务清单**:
- [x] 调研技术方案（前端框架、后端框架、图表库）
- [x] 设计项目目录结构
- [x] 创建 UI 设计系统
- [ ] 创建项目基础骨架
- [ ] 配置开发环境

**关键决策点**:
- ✅ 前端框架选择：Vue 3 + TypeScript + Tailwind CSS
- ✅ 后端框架选择：FastAPI + Uvicorn
- ✅ 图表库选择：Apache ECharts
- ✅ 技术指标库：pandas-ta
- ✅ 数据源：yfinance (价格) + AKShare (宏观)
- ✅ 定时任务：APScheduler
- ✅ 数据存储：SQLite + 文件缓存

---

### 阶段 2: 数据模块开发
**状态**: `pending`
**目标**: 实现数据获取、处理与存储

**任务清单**:
- [ ] 实现价格数据获取（现货黄金、COMEX 期货）
- [ ] 实现关联资产数据获取（美元指数、实际利率）
- [ ] 实现宏观事件数据获取
- [ ] 实现新闻情绪数据获取
- [ ] 实现数据清洗与时间对齐
- [ ] 实现数据存储

**涉及字段**: 参考 [设计文档 02](设计文档/设计文档-02-数据字段与指标规范.md)

---

### 阶段 3: 指标计算模块开发
**状态**: `pending`
**目标**: 实现派生指标计算

**任务清单**:
- [ ] 实现趋势类指标（均线、趋势方向/强度）
- [ ] 实现区间与结构位识别（支撑/阻力/区间边界）
- [ ] 实现波动与风险指标（ATR、波动状态）
- [ ] 实现指标数据存储

---

### 阶段 4: 策略引擎开发
**状态**: `pending`
**目标**: 实现市场状态识别与信号生成

**任务清单**:
- [ ] 实现市场状态判定逻辑（趋势/震荡/不清晰）
- [ ] 实现趋势模式交易规则
- [ ] 实现震荡模式交易规则
- [ ] 实现信号等级映射
- [ ] 实现仓位建议逻辑
- [ ] 实现风险控制规则（事件过滤）

**核心规则**: 参考 [设计文档 01](设计文档/设计文档-01-策略规则设计.md)

---

### 阶段 5: 信号解释生成器开发
**状态**: `pending`
**目标**: 实现教学型解释文本生成

**任务清单**:
- [ ] 实现市场状态解释生成
- [ ] 实现信号触发条件解释生成
- [ ] 实现风险点解释生成
- [ ] 实现关键位意义解释生成

---

### 阶段 6: 后端 API 开发
**状态**: `pending`
**目标**: 实现 Web 后端接口

**任务清单**:
- [ ] 设计 API 接口规范
- [ ] 实现数据刷新接口
- [ ] 实现信号查询接口
- [ ] 实现聊天问答接口
- [ ] 实现定时任务（每日 14:00 自动更新）

---

### 阶段 7: 前端界面开发
**状态**: `pending`
**目标**: 实现 Web 界面

**任务清单**:
- [ ] 实现首页（Dashboard）布局
- [ ] 实现信号卡片组件
- [ ] 实现图表组件（趋势线 + 关键位）
- [ ] 实现风险提示区
- [ ] 实现仓位建议区
- [ ] 实现解释区
- [ ] 实现聊天页面
- [ ] 实现手动刷新功能
- [ ] 实现自动更新显示

**页面规范**: 参考 [设计文档 03](设计文档/设计文档-03-页面与交互原型说明.md)

---

### 阶段 8: 聊天问答系统开发
**状态**: `pending`
**目标**: 实现智能问答功能

**任务清单**:
- [ ] 实现问题意图识别
- [ ] 实现信号解释问答
- [ ] 实现关键位查询问答
- [ ] 实现操作建议问答
- [ ] 对接 LLM（可选，用于更灵活的问答）

---

### 阶段 9: 集成测试
**状态**: `pending`
**目标**: 端到端测试与问题修复

**任务清单**:
- [ ] 测试数据获取流程
- [ ] 测试信号生成准确性
- [ ] 测试界面交互流程
- [ ] 测试定时更新功能
- [ ] 修复发现的 bug
- [ ] 性能优化

---

### 阶段 10: 部署与文档
**状态**: `pending`
**目标**: 本地部署配置与使用文档

**任务清单**:
- [x] 编写部署文档
- [x] 编写使用说明
- [x] 配置启动脚本
- [ ] 本地环境验证

---

### 阶段 11: 代码审查问题修复
**状态**: `complete`
**目标**: 修复代码审查中发现的7个主要问题

**任务清单**:

#### P0 - 必须修复（当前无法稳定运行）
- [x] 修复 routes.py 中 settings 未导入导致的 API 报错
- [x] 修复 MarketAnalysis.indicators 传 None 导致的验证错误
- [x] 修复 Parquet 缓存缺少依赖问题

#### P1 - 重要修复（关键需求缺失）
- [x] 实现每日 14:00 自动更新功能
- [x] 实现图表展示功能（趋势线 + 关键位）
- [x] 接入宏观/新闻/实际利率等多源数据

#### P2 - 可后置（体验与安全）
- [x] 修复 v-html 的 XSS 风险
- [x] 添加测试用例

---

### 阶段 12: 代码优化与需求一致性修复
**状态**: `complete`
**目标**: 修复新发现的显示和需求一致性问题

**任务清单**:

#### P0 - 显示问题修复
- [x] 修复聊天输出重复格式化导致粗体失效
- [x] 修复教学解释区格式化缺失问题

#### P1 - 需求一致性修复
- [x] 移除图表中的 MA20/MA60，只保留趋势与关键位

#### P1 - 功能完整性
- [x] 宏观/新闻数据从占位符改为真实数据源（在阶段13实现）

#### P2 - 维护性优化
- [x] requirements.txt 中 httpx 去重

---

### 阶段 13: 宏观/新闻数据源接入
**状态**: `complete`
**目标**: 从占位符改为真实的宏观事件和新闻数据源

**实施计划**:

#### 阶段 1: 配置与字段扩展（最小改动）
- [x] 在 `.env.example` 中添加 API Key 配置
- [x] 在 `config.py` 中加载并暴露 TE_API_KEY 和 FINNHUB_API_KEY
- [x] 在 `schemas.py` 的 MarketAnalysis 新增字段：
  - `macro_events: list[dict]`
  - `news_sentiment: list[dict]`
- **验收**: ✅ /analysis 返回时字段存在（允许为空）

#### 阶段 2: 宏观事件接入（Trading Economics）
- [x] 在 `data_provider.get_macro_events()` 中调用 TE 经济日历接口
- [x] 过滤最近 14 天（或未来 7 天）
- [x] 映射字段为统一格式：event_date, event_name, event_level, event_direction
- [x] 添加 API 调用频率限制（避免超配额）
- [x] 实现回退机制：无API Key时使用模拟数据
- **验收**: ✅ /analysis 的 macro_events 至少 3 条

#### 阶段 3: 新闻接入（Finnhub）
- [x] 在 `data_provider.get_news_sentiment()` 中调用 Finnhub 新闻接口
- [x] 取最近 10 条
- [x] 生成情绪倾向（简易规则：关键词打分）
- [x] 输出格式：news_date, headline, sentiment
- [x] 实现回退机制：无API Key时使用模拟数据
- **验收**: ✅ /analysis 的 news_sentiment 至少 3 条

#### 阶段 4: 分析与解释融合
- [x] `strategy.analyze()` 接收宏观/新闻数据
- [x] 在 explanation 中追加宏观风险提示
- [x] 在 explanation 中追加新闻情绪摘要
- **验收**: ✅ explanation 中出现"宏观事件"与"新闻情绪"说明

#### 阶段 5: 前端展示与聊天
- [x] Dashboard 新增宏观事件列表卡片
- [x] Dashboard 新增新闻摘要列表卡片
- [x] Chat 支持问答：宏观事件、新闻情绪
- **验收**:
  - ✅ 页面可见宏观与新闻模块
  - ✅ 问答能返回相应内容

**调用频率控制**:
- 自动更新：每天 14:00 调一次
- 手动刷新：通过缓存TTL控制
- **已实现**: 后端使用缓存避免频繁API调用

---

### 阶段 15: LLM 集成(可选增强)
**状态**: `complete`
**目标**: 集成 LLM 作为可选增强层,提升解释质量

**实施计划**: 详见 [task_plan_llm.md](../task_plan_llm.md)

**任务清单**:

#### 阶段 1: 配置与开关
- [ ] 在 `backend/core/config.py` 添加 LLM 配置项
- [ ] 在 `.env.example` 添加配置示例
- [ ] 验收: ✅ 配置加载正常,默认关闭 LLM

#### 阶段 2: LLM 服务层
- [ ] 创建 `backend/services/llm_client.py`
- [ ] 实现 LLMClient 类,包含超时/重试/回退机制
- [ ] 实现频率限制器
- [ ] 验收: ✅ LLM 不可用时自动回退

#### 阶段 3: 数据模型扩展
- [ ] 在 `backend/models/schemas.py` 扩展 MarketAnalysis
- [ ] 添加 `llm_explanation` 和 `llm_news_summary` 字段
- [ ] 验收: ✅ 新字段为可选,不影响现有 API

#### 阶段 4: 解释生成接入 LLM
- [ ] 修改 `backend/services/strategy.py`
- [ ] 在 `analyze()` 方法中接入 LLM 生成解释
- [ ] 设计 LLM Prompt
- [ ] 验收: ✅ LLM 失败时自动回退到规则解释

#### 阶段 5: 新闻情绪语义增强
- [ ] 修改 `backend/services/data_provider.py`
- [ ] 使用 LLM 增强新闻情绪分析
- [ ] 验收: ✅ 能正确识别否定/反转语义

#### 阶段 6: Chat 接入 LLM
- [ ] 修改 `backend/api/routes.py` 的 `/chat` 接口
- [ ] 优先使用 LLM,失败时回退到规则问答
- [ ] 验收: ✅ LLM 回答与当前分析一致

#### 阶段 7: 前端适配
- [ ] 修改 `frontend/src/api/index.ts` 扩展类型
- [ ] 修改 `frontend/src/views/DashboardView.vue` 显示 LLM 字段
- [ ] 验收: ✅ LLM 解释优先显示,无 LLM 时规则解释正常

#### 阶段 8: 日志与成本控制
- [ ] 实现 LLM 调用日志记录
- [ ] 实现调用频率限制
- [ ] 验收: ✅ 所有关键点都有日志记录

#### 阶段 9: 测试与验收
- [ ] 单元测试
- [ ] 集成测试
- [ ] 手动测试
- [ ] 性能测试

**关键决策**:
- ✅ LLM 提供商: OpenRouter (统一接口,支持多模型)
- ✅ 模型选择: Anthropic Claude 3.5 Sonnet (推理能力强,适合金融)
- ✅ 频率控制: 软限制 (平衡成本和体验)
- ✅ 回退策略: 静默回退 (不影响基础功能)

---

## 已记录的错误

| 错误 | 尝试 | 解决方案 | 状态 |
|------|------|----------|------|
| UI/UX Pro Max 搜索脚本有语法错误 | 运行 `python3 .../search.py --design-system` | 手动创建设计系统文件 | ✅ 已解决 |
| routes.py settings 未导入 | 1 | 添加 `from core.config import settings` | ✅ 已解决 |
| MarketAnalysis.indicators 传 None | 1 | 改为 `TechnicalIndicators()` | ✅ 已解决 |
| Parquet 缓存缺少依赖 | 1 | 添加 pyarrow>=14.0.0 | ✅ 已解决 |

---

## 关键决策记录

| 决策点 | 选择 | 原因 | 日期 |
|--------|------|------|------|
| 前端框架 | Vue 3 + TypeScript + Tailwind CSS | 组件化开发、生态成熟、本地部署简单 | 2026-02-03 |
| 后端框架 | FastAPI + Uvicorn | Python 生态丰富、自动 API 文档、高性能 | 2026-02-03 |
| 图表库 | Apache ECharts | 功能强大、支持金融图表、Vue 集成好 | 2026-02-03 |
| 技术指标 | pandas-ta | 纯 Python、150+ 指标、与 pandas 无缝集成 | 2026-02-03 |
| 数据源 | yfinance + AKShare | 免费、无需 API Key、数据丰富 | 2026-02-03 |
| 数据存储 | SQLite + 文件缓存 | 本地部署简单、无需额外服务 | 2026-02-03 |
| 定时任务 | APScheduler | 功能强大、支持 Cron、生产环境可用 | 2026-02-03 |
| UI 风格 | 深色金融交易风格 | 专业、突出数据、符合交易软件习惯 | 2026-02-03 |
